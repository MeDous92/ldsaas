-- 1) Create ENUM type if it doesn't exist
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'user_status') THEN
        CREATE TYPE user_status AS ENUM ('pending','active','inactive');
    END IF;
END$$;

-- 2) Add the column with default + NOT NULL (idempotent)
ALTER TABLE users
ADD COLUMN IF NOT EXISTS status user_status DEFAULT 'pending'::user_status NOT NULL;

-- 3) Backfill based on current data (cast each label to user_status)

-- pending: invited but no password yet
UPDATE users
SET status = 'pending'::user_status
WHERE status IS DISTINCT FROM 'pending'::user_status
  AND password_hash IS NULL
  AND invite_token_hash IS NOT NULL
  AND is_active = TRUE;

-- active: has password and not deactivated
UPDATE users
SET status = 'active'::user_status
WHERE status IS DISTINCT FROM 'active'::user_status
  AND password_hash IS NOT NULL
  AND is_active = TRUE;

-- inactive: soft-deactivated
UPDATE users
SET status = 'inactive'::user_status
WHERE status IS DISTINCT FROM 'inactive'::user_status
  AND is_active = FALSE;

-- 4) Safety net: coerce any remaining NULLs or mismatches
UPDATE users
SET status = (
    CASE WHEN is_active THEN 'active'::user_status ELSE 'inactive'::user_status END
)
WHERE status IS NULL
   OR status NOT IN ('pending'::user_status,'active'::user_status,'inactive'::user_status);
